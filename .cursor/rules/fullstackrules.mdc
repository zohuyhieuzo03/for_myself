---
description: Full Stack FastAPI Template development guidelines and patterns
globs:
alwaysApply: true
---

# Cursor Rules - Full Stack FastAPI Template
# Luồng phát triển từ Backend đến Frontend

## 🏗️ Kiến trúc tổng quan
Dự án này sử dụng:
- **Backend**: FastAPI + SQLModel + PostgreSQL + Alembic
- **Frontend**: React + TypeScript + TanStack Router + Chakra UI
- **API Client**: Auto-generated từ OpenAPI schema

## 📋 Quy trình phát triển tính năng mới

### 1. Backend First Approach
Luôn bắt đầu từ backend trước khi implement frontend:

#### 1.1 Database Models (`backend/app/models.py`)
```python
# Pattern cho mỗi entity:
class EntityBase(SQLModel):          # Base fields
class EntityCreate(EntityBase):      # Fields for creation
class EntityUpdate(BaseModel):       # Fields for update (all optional)
class Entity(EntityBase, table=True): # Database model
class EntityPublic(EntityBase):      # API response model
class EntitiesPublic(SQLModel):      # List response wrapper
```

#### 1.2 CRUD Operations (`backend/app/crud/`)
- Tạo file CRUD cho entity mới
- Implement các hàm: create, read, update, delete
- Sử dụng SQLModel và SQLAlchemy patterns
- **NHỚ**: Luôn import functions vào `crud/__init__.py` và thêm vào `__all__` list để API routes có thể sử dụng

#### 1.3 API Routes (`backend/app/api/routes/`)
- Tạo route file cho entity
- Implement endpoints: GET, POST, PUT, DELETE
- Sử dụng dependency injection cho authentication
- Validate input với Pydantic models

#### 1.4 Database Migration (`backend/app/alembic/versions/`)
- Tạo migration script với Alembic: `cd backend && source .venv/bin/activate && alembic revision --autogenerate`
- Test migration trên development database: `cd backend && source .venv/bin/activate && alembic upgrade head`

### 2. API Client Generation
Sau khi backend hoàn thành:

#### 2.1 Generate OpenAPI Schema & Client
```bash
# Chạy script để generate OpenAPI schema và TypeScript client
cd backend && source .venv/bin/activate && cd .. && ./scripts/generate-client.sh
```

### 3. Frontend Implementation

#### 3.1 Component Structure
```
frontend/src/components/
├── EntityName/
│   ├── EntityNameList.tsx      # List view
│   ├── EntityNameForm.tsx      # Create/Edit form
│   ├── EntityNameItem.tsx      # Individual item
│   └── EntityNameDetail.tsx    # Detail view
```

#### 3.2 API Integration Pattern
```typescript
// Sử dụng auto-generated client
import { EntityService } from "@/client"

// React Query hooks
const { data, isLoading, error } = useQuery({
  queryKey: ["entities"],
  queryFn: () => EntityService.readEntities()
})
```

#### 3.3 Routing (`frontend/src/routes/`)
- Tạo route files trong `_layout/`
- Sử dụng TanStack Router patterns
- Implement nested routing nếu cần

## 🔄 Data Flow Pattern

### Backend → Frontend Flow:
1. **Model Definition** → `models.py`
2. **CRUD Operations** → `crud/entity.py`
3. **API Endpoints** → `api/routes/entity.py`
4. **OpenAPI Schema** → Auto-generated
5. **TypeScript Client** → `client/sdk.gen.ts`
6. **React Components** → `components/Entity/`
7. **Routes** → `routes/_layout/`

## 📁 File Organization Rules

### Backend Structure:
```
backend/app/
├── models.py              # All SQLModel definitions
├── crud/                  # Database operations
├── api/routes/           # API endpoints
├── core/                 # Configuration & security
└── alembic/versions/     # Database migrations
```

### Frontend Structure:
```
frontend/src/
├── components/           # React components
├── routes/              # TanStack Router routes
├── client/              # Auto-generated API client
├── hooks/               # Custom React hooks
└── utils/               # Utility functions
```

## 🎯 Naming Conventions

### Backend:
- **Models**: PascalCase (`User`, `Transaction`)
- **API Routes**: snake_case (`/api/v1/accounts/`)
- **CRUD Functions**: snake_case (`create_account`)
- **Database Tables**: snake_case (auto-generated)

### Frontend:
- **Components**: PascalCase (`AccountList`, `TransactionForm`)
- **Files**: PascalCase (`AccountList.tsx`)
- **Hooks**: camelCase (`useAccountData`)
- **API Calls**: camelCase (`readAccounts`)

## 🔐 Authentication & Authorization

### Backend:
- Sử dụng JWT tokens
- Dependency injection cho current user
- Role-based access control với `is_superuser`

### Frontend:
- Store JWT trong React Query cache
- Protected routes với authentication check
- Role-based UI rendering

## 🧪 Testing Strategy

### Backend Testing:
- Unit tests cho CRUD operations: `source .venv/bin/activate && pytest`
- Integration tests cho API endpoints: `source .venv/bin/activate && pytest tests/integration/`
- Database fixtures cho test data

### Frontend Testing:
- Testing script: `npx tsc --noEmit`
- Component tests với React Testing Library: `npm test`
- E2E tests với Playwright: `npm run test:e2e`
- API mocking cho unit tests
- Linting: `npm run lint`

## 📊 State Management

### Frontend State:
- **Server State**: React Query (TanStack Query)
- **Client State**: React useState/useReducer
- **Form State**: React Hook Form
- **UI State**: Chakra UI components

## 🚀 Development Workflow

1. **Design Database Schema** → Update `models.py`
2. **Create Migration** → `source .venv/bin/activate && alembic revision --autogenerate`
3. **Implement CRUD** → `crud/entity.py`
4. **Create API Routes** → `api/routes/entity.py`
5. **Test Backend** → `source .venv/bin/activate && pytest`
6. **Generate Client** → `source .venv/bin/activate && ./scripts/generate-client.sh`
7. **Create Components** → `components/Entity/`
8. **Add Routes** → `routes/_layout/`
9. **Generate Routes** → `cd frontend && npx @tanstack/router-cli generate`
10. **Test Frontend** → `npm run lint && npx tsc --noEmit`

## 🔧 Code Quality Rules

### Backend:
- Type hints cho tất cả functions
- Pydantic validation cho input/output
- SQLModel cho database operations
- Alembic cho migrations

### Frontend:
- TypeScript strict mode
- ESLint + Prettier formatting
- Component composition over inheritance
- Custom hooks cho business logic

## 🔄 Code Refactoring Rules

### DRY Principle (Don't Repeat Yourself):
- **Utility Functions**: Tạo utility functions trong `backend/app/utils.py` cho logic chung
- **Validation Logic**: Sử dụng shared validators thay vì duplicate code
- **Component Logic**: Extract reusable logic vào custom hooks

### File Organization for Utilities:
```
backend/app/
├── utils.py              # Backend utility functions
├── models.py             # Import from utils.py
└── crud/                 # Import from utils.py

frontend/src/
├── utils.ts              # Frontend utility functions
├── components/           # Import from utils.ts
└── hooks/                # Import from utils.ts
```

## 📝 Documentation Standards

- **API Documentation**: Auto-generated từ FastAPI
- **Component Props**: TypeScript interfaces
- **Database Schema**: Alembic migration comments
- **README**: Update khi thêm tính năng mới

## 🎨 UI/UX Guidelines

- Sử dụng Chakra UI components
- Responsive design với mobile-first
- Consistent spacing và typography
- Loading states và error handling
- Form validation với user feedback

## 🔍 Debugging Tips

### Backend:
- Sử dụng FastAPI automatic docs (`/docs`)
- Database query logging
- Pydantic validation errors

### Frontend:
- React DevTools
- TanStack Query DevTools
- Browser Network tab cho API calls
- Console logging cho state changes

## 🚨 Error Handling & Debugging Rules

### ❌ KHÔNG BAO GIỜ Fix Chắp Vá:
- **Không** thêm workaround hoặc band-aid solutions
- **Không** thêm setTimeout, useRef phức tạp để "fix" symptoms
- **Không** ignore lỗi hoặc suppress warnings

### ✅ LUÔN Tìm Nguyên Nhân Gốc Rễ:
1. **Phân tích kỹ lưỡng** error message và stack trace
2. **Tìm hiểu** tại sao lỗi xảy ra, không chỉ làm sao để nó biến mất
3. **Đọc documentation** của library/framework liên quan
4. **Kiểm tra** các component tương tự trong codebase

### 🔧 Debugging Process:
```typescript
// ❌ BAD: Fix chắp vá
const [isOpen, setIsOpen] = useState(false)
const resetRef = useRef<(() => void) | null>(null)
resetRef.current = reset // Side effect trong render!

useEffect(() => {
  if (!isOpen) {
    const timer = setTimeout(() => {
      resetRef.current?.()
    }, 150) // Magic number!
    return () => clearTimeout(timer)
  }
}, [isOpen])

// ✅ GOOD: Tìm nguyên nhân và fix đúng
const mutation = useMutation({
  onSuccess: () => {
    showSuccessToast("Success!")
    reset() // Reset trực tiếp trong callback
    setIsOpen(false) // Đóng dialog
  }
})
```

### 🎯 Debugging Checklist:
1. **Đọc error message** cẩn thận
2. **Tìm hiểu** nguyên nhân gốc rễ
3. **Kiểm tra** documentation và best practices
4. **Áp dụng** giải pháp đơn giản nhất
5. **Test** để đảm bảo fix hoạt động
6. **Refactor** nếu cần thiết

### 📋 Common Error Patterns:

#### React Hooks Errors:
- **"Rendered more hooks than during the previous render"**: 
  - Nguyên nhân: Conditional hooks hoặc side effects trong render
  - Fix: Đảm bảo hooks được gọi theo thứ tự nhất quán

#### Form Validation Errors:
- **Form không reset sau submit**:
  - Nguyên nhân: Timing issues với dialog state
  - Fix: Reset trong success callback, không dùng useEffect phức tạp

#### API Integration Errors:
- **CORS hoặc authentication issues**:
  - Nguyên nhân: Configuration sai hoặc token expired
  - Fix: Kiểm tra API configuration và token management

---

**Lưu ý**: Luôn tuân theo pattern này để đảm bảo consistency và maintainability của codebase.