---
description: Full Stack FastAPI Template development guidelines and patterns
globs:
alwaysApply: true
---

# Cursor Rules - Full Stack FastAPI Template
# Luá»“ng phÃ¡t triá»ƒn tá»« Backend Ä‘áº¿n Frontend

## ğŸ—ï¸ Kiáº¿n trÃºc tá»•ng quan
Dá»± Ã¡n nÃ y sá»­ dá»¥ng:
- **Backend**: FastAPI + SQLModel + PostgreSQL + Alembic
- **Frontend**: React + TypeScript + TanStack Router + Chakra UI
- **API Client**: Auto-generated tá»« OpenAPI schema

## ğŸ“‹ Quy trÃ¬nh phÃ¡t triá»ƒn tÃ­nh nÄƒng má»›i

### 1. Backend First Approach
LuÃ´n báº¯t Ä‘áº§u tá»« backend trÆ°á»›c khi implement frontend:

#### 1.1 Database Models (`backend/app/models.py`)
```python
# Pattern cho má»—i entity:
class EntityBase(SQLModel):          # Base fields
class EntityCreate(EntityBase):      # Fields for creation
class EntityUpdate(BaseModel):       # Fields for update (all optional)
class Entity(EntityBase, table=True): # Database model
class EntityPublic(EntityBase):      # API response model
class EntitiesPublic(SQLModel):      # List response wrapper
```

#### 1.2 CRUD Operations (`backend/app/crud/`)
- Táº¡o file CRUD cho entity má»›i
- Implement cÃ¡c hÃ m: create, read, update, delete
- Sá»­ dá»¥ng SQLModel vÃ  SQLAlchemy patterns

#### 1.3 API Routes (`backend/app/api/routes/`)
- Táº¡o route file cho entity
- Implement endpoints: GET, POST, PUT, DELETE
- Sá»­ dá»¥ng dependency injection cho authentication
- Validate input vá»›i Pydantic models

#### 1.4 Database Migration (`backend/app/alembic/versions/`)
- Táº¡o migration script vá»›i Alembic: `source .venv/bin/activate && alembic revision --autogenerate`
- Test migration trÃªn development database: `source .venv/bin/activate && alembic upgrade head`

### 2. API Client Generation
Sau khi backend hoÃ n thÃ nh:

#### 2.1 Generate OpenAPI Schema & Client
```bash
# Cháº¡y script Ä‘á»ƒ generate OpenAPI schema vÃ  TypeScript client
source .venv/bin/activate && ./scripts/generate-client.sh
```

### 3. Frontend Implementation

#### 3.1 Component Structure
```
frontend/src/components/
â”œâ”€â”€ EntityName/
â”‚   â”œâ”€â”€ EntityNameList.tsx      # List view
â”‚   â”œâ”€â”€ EntityNameForm.tsx      # Create/Edit form
â”‚   â”œâ”€â”€ EntityNameItem.tsx      # Individual item
â”‚   â””â”€â”€ EntityNameDetail.tsx    # Detail view
```

#### 3.2 API Integration Pattern
```typescript
// Sá»­ dá»¥ng auto-generated client
import { EntityService } from "@/client"

// React Query hooks
const { data, isLoading, error } = useQuery({
  queryKey: ["entities"],
  queryFn: () => EntityService.readEntities()
})
```

#### 3.3 Routing (`frontend/src/routes/`)
- Táº¡o route files trong `_layout/`
- Sá»­ dá»¥ng TanStack Router patterns
- Implement nested routing náº¿u cáº§n

## ğŸ”„ Data Flow Pattern

### Backend â†’ Frontend Flow:
1. **Model Definition** â†’ `models.py`
2. **CRUD Operations** â†’ `crud/entity.py`
3. **API Endpoints** â†’ `api/routes/entity.py`
4. **OpenAPI Schema** â†’ Auto-generated
5. **TypeScript Client** â†’ `client/sdk.gen.ts`
6. **React Components** â†’ `components/Entity/`
7. **Routes** â†’ `routes/_layout/`

## ğŸ“ File Organization Rules

### Backend Structure:
```
backend/app/
â”œâ”€â”€ models.py              # All SQLModel definitions
â”œâ”€â”€ crud/                  # Database operations
â”œâ”€â”€ api/routes/           # API endpoints
â”œâ”€â”€ core/                 # Configuration & security
â””â”€â”€ alembic/versions/     # Database migrations
```

### Frontend Structure:
```
frontend/src/
â”œâ”€â”€ components/           # React components
â”œâ”€â”€ routes/              # TanStack Router routes
â”œâ”€â”€ client/              # Auto-generated API client
â”œâ”€â”€ hooks/               # Custom React hooks
â””â”€â”€ utils/               # Utility functions
```

## ğŸ¯ Naming Conventions

### Backend:
- **Models**: PascalCase (`User`, `Transaction`)
- **API Routes**: snake_case (`/api/v1/accounts/`)
- **CRUD Functions**: snake_case (`create_account`)
- **Database Tables**: snake_case (auto-generated)

### Frontend:
- **Components**: PascalCase (`AccountList`, `TransactionForm`)
- **Files**: PascalCase (`AccountList.tsx`)
- **Hooks**: camelCase (`useAccountData`)
- **API Calls**: camelCase (`readAccounts`)

## ğŸ” Authentication & Authorization

### Backend:
- Sá»­ dá»¥ng JWT tokens
- Dependency injection cho current user
- Role-based access control vá»›i `is_superuser`

### Frontend:
- Store JWT trong React Query cache
- Protected routes vá»›i authentication check
- Role-based UI rendering

## ğŸ§ª Testing Strategy

### Backend Testing:
- Unit tests cho CRUD operations: `source .venv/bin/activate && pytest`
- Integration tests cho API endpoints: `source .venv/bin/activate && pytest tests/integration/`
- Database fixtures cho test data

### Frontend Testing:
- Testing script: `npx tsc --noEmit`
- Component tests vá»›i React Testing Library: `npm test`
- E2E tests vá»›i Playwright: `npm run test:e2e`
- API mocking cho unit tests
- Linting: `npm run lint`

## ğŸ“Š State Management

### Frontend State:
- **Server State**: React Query (TanStack Query)
- **Client State**: React useState/useReducer
- **Form State**: React Hook Form
- **UI State**: Chakra UI components

## ğŸš€ Development Workflow

1. **Design Database Schema** â†’ Update `models.py`
2. **Create Migration** â†’ `source .venv/bin/activate && alembic revision --autogenerate`
3. **Implement CRUD** â†’ `crud/entity.py`
4. **Create API Routes** â†’ `api/routes/entity.py`
5. **Test Backend** â†’ `source .venv/bin/activate && pytest`
6. **Generate Client** â†’ `source .venv/bin/activate && ./scripts/generate-client.sh`
7. **Create Components** â†’ `components/Entity/`
8. **Add Routes** â†’ `routes/_layout/`
9. **Test Frontend** â†’ `npm run lint && npx tsc --noEmit`

## ğŸ”§ Code Quality Rules

### Backend:
- Type hints cho táº¥t cáº£ functions
- Pydantic validation cho input/output
- SQLModel cho database operations
- Alembic cho migrations

### Frontend:
- TypeScript strict mode
- ESLint + Prettier formatting
- Component composition over inheritance
- Custom hooks cho business logic

## ğŸ”„ Code Refactoring Rules

### DRY Principle (Don't Repeat Yourself):
- **Utility Functions**: Táº¡o utility functions trong `backend/app/utils.py` cho logic chung
- **Validation Logic**: Sá»­ dá»¥ng shared validators thay vÃ¬ duplicate code
- **Component Logic**: Extract reusable logic vÃ o custom hooks

### Refactoring Guidelines:

#### Backend Refactoring:
```python
# âŒ BAD: Duplicate validation functions
class IncomeCreate(IncomeBase):
    @field_validator('sprint_id', mode='before')
    @classmethod
    def convert_empty_string_to_none(cls, v):
        if v == "": return None
        return v

class TransactionCreate(TransactionBase):
    @field_validator('sprint_id', mode='before')
    @classmethod
    def convert_empty_string_to_none(cls, v):
        if v == "": return None
        return v

# âœ… GOOD: Shared utility function
# In utils.py
def convert_empty_string_to_none(v: Any) -> Any:
    """Convert empty string to None for optional UUID fields"""
    if v == "": return None
    return v

# In models.py
from app.utils import convert_empty_string_to_none

class IncomeCreate(IncomeBase):
    @field_validator('sprint_id', mode='before')
    @classmethod
    def validate_sprint_id(cls, v):
        return convert_empty_string_to_none(v)
```

#### Frontend Refactoring:
```typescript
// âŒ BAD: Duplicate form processing
const onSubmitIncome = (data: IncomeCreate) => {
  const processedData = {
    ...data,
    sprint_id: data.sprint_id === "" ? null : data.sprint_id,
  }
  mutation.mutate(processedData)
}

const onSubmitTransaction = (data: TransactionCreate) => {
  const processedData = {
    ...data,
    category_id: data.category_id === "" ? null : data.category_id,
    sprint_id: data.sprint_id === "" ? null : data.sprint_id,
  }
  mutation.mutate(processedData)
}

// âœ… GOOD: Shared utility function
// In utils.ts
export const processOptionalFields = <T extends Record<string, any>>(
  data: T,
  optionalFields: (keyof T)[]
): T => {
  const processed = { ...data }
  optionalFields.forEach(field => {
    if (processed[field] === "") {
      processed[field] = null
    }
  })
  return processed
}

// In components
const onSubmitIncome = (data: IncomeCreate) => {
  const processedData = processOptionalFields(data, ['sprint_id'])
  mutation.mutate(processedData)
}
```

### Refactoring Checklist:
1. **Identify Duplicates**: TÃ¬m code Ä‘Æ°á»£c láº·p láº¡i 3+ láº§n
2. **Extract Utilities**: Táº¡o utility functions trong `utils.py` hoáº·c `utils.ts`
3. **Update Imports**: Import vÃ  sá»­ dá»¥ng utility functions
4. **Test Changes**: Äáº£m báº£o functionality khÃ´ng thay Ä‘á»•i
5. **Update Documentation**: Cáº­p nháº­t docstrings vÃ  comments

### File Organization for Utilities:
```
backend/app/
â”œâ”€â”€ utils.py              # Backend utility functions
â”œâ”€â”€ models.py             # Import from utils.py
â””â”€â”€ crud/                 # Import from utils.py

frontend/src/
â”œâ”€â”€ utils.ts              # Frontend utility functions
â”œâ”€â”€ components/           # Import from utils.ts
â””â”€â”€ hooks/                # Import from utils.ts
```

## ğŸ“ Documentation Standards

- **API Documentation**: Auto-generated tá»« FastAPI
- **Component Props**: TypeScript interfaces
- **Database Schema**: Alembic migration comments
- **README**: Update khi thÃªm tÃ­nh nÄƒng má»›i

## ğŸ¨ UI/UX Guidelines

- Sá»­ dá»¥ng Chakra UI components
- Responsive design vá»›i mobile-first
- Consistent spacing vÃ  typography
- Loading states vÃ  error handling
- Form validation vá»›i user feedback

## ğŸ” Debugging Tips

### Backend:
- Sá»­ dá»¥ng FastAPI automatic docs (`/docs`)
- Database query logging
- Pydantic validation errors

### Frontend:
- React DevTools
- TanStack Query DevTools
- Browser Network tab cho API calls
- Console logging cho state changes

---

**LÆ°u Ã½**: LuÃ´n tuÃ¢n theo pattern nÃ y Ä‘á»ƒ Ä‘áº£m báº£o consistency vÃ  maintainability cá»§a codebase.