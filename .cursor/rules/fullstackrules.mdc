---
description: Full Stack FastAPI Template development guidelines and patterns
globs:
alwaysApply: true
---

# Cursor Rules - Full Stack FastAPI Template
# Luá»“ng phÃ¡t triá»ƒn tá»« Backend Ä‘áº¿n Frontend

## ğŸ—ï¸ Kiáº¿n trÃºc tá»•ng quan
Dá»± Ã¡n nÃ y sá»­ dá»¥ng:
- **Backend**: FastAPI + SQLModel + PostgreSQL + Alembic
- **Frontend**: React + TypeScript + TanStack Router + Chakra UI
- **API Client**: Auto-generated tá»« OpenAPI schema

## ğŸ“‹ Quy trÃ¬nh phÃ¡t triá»ƒn tÃ­nh nÄƒng má»›i

### 1. Backend First Approach
LuÃ´n báº¯t Ä‘áº§u tá»« backend trÆ°á»›c khi implement frontend:

#### 1.1 Database Models (`backend/app/models.py`)
```python
# Pattern cho má»—i entity:
class EntityBase(SQLModel):          # Base fields
class EntityCreate(EntityBase):      # Fields for creation
class EntityUpdate(BaseModel):       # Fields for update (all optional)
class Entity(EntityBase, table=True): # Database model
class EntityPublic(EntityBase):      # API response model
class EntitiesPublic(SQLModel):      # List response wrapper
```

#### 1.2 CRUD Operations (`backend/app/crud/`)
- Táº¡o file CRUD cho entity má»›i
- Implement cÃ¡c hÃ m: create, read, update, delete
- Sá»­ dá»¥ng SQLModel vÃ  SQLAlchemy patterns
- **NHá»š**: LuÃ´n import functions vÃ o `crud/__init__.py` vÃ  thÃªm vÃ o `__all__` list Ä‘á»ƒ API routes cÃ³ thá»ƒ sá»­ dá»¥ng

#### 1.3 API Routes (`backend/app/api/routes/`)
- Táº¡o route file cho entity
- Implement endpoints: GET, POST, PUT, DELETE
- Sá»­ dá»¥ng dependency injection cho authentication
- Validate input vá»›i Pydantic models

#### 1.4 Database Migration (`backend/app/alembic/versions/`)
- Táº¡o migration script vá»›i Alembic: `cd backend && source .venv/bin/activate && alembic revision --autogenerate`
- Test migration trÃªn development database: `cd backend && source .venv/bin/activate && alembic upgrade head`

### 2. API Client Generation
Sau khi backend hoÃ n thÃ nh:

#### 2.1 Generate OpenAPI Schema & Client
```bash
# Cháº¡y script Ä‘á»ƒ generate OpenAPI schema vÃ  TypeScript client
cd backend && source .venv/bin/activate && cd .. && ./scripts/generate-client.sh
```

### 3. Frontend Implementation

#### 3.1 Component Structure
```
frontend/src/components/
â”œâ”€â”€ EntityName/
â”‚   â”œâ”€â”€ EntityNameList.tsx      # List view
â”‚   â”œâ”€â”€ EntityNameForm.tsx      # Create/Edit form
â”‚   â”œâ”€â”€ EntityNameItem.tsx      # Individual item
â”‚   â””â”€â”€ EntityNameDetail.tsx    # Detail view
```

#### 3.2 API Integration Pattern
```typescript
// Sá»­ dá»¥ng auto-generated client
import { EntityService } from "@/client"

// React Query hooks
const { data, isLoading, error } = useQuery({
  queryKey: ["entities"],
  queryFn: () => EntityService.readEntities()
})
```

#### 3.3 Routing (`frontend/src/routes/`)
- Táº¡o route files trong `_layout/`
- Sá»­ dá»¥ng TanStack Router patterns
- Implement nested routing náº¿u cáº§n

## ğŸ”„ Data Flow Pattern

### Backend â†’ Frontend Flow:
1. **Model Definition** â†’ `models.py`
2. **CRUD Operations** â†’ `crud/entity.py`
3. **API Endpoints** â†’ `api/routes/entity.py`
4. **OpenAPI Schema** â†’ Auto-generated
5. **TypeScript Client** â†’ `client/sdk.gen.ts`
6. **React Components** â†’ `components/Entity/`
7. **Routes** â†’ `routes/_layout/`

## ğŸ“ File Organization Rules

### Backend Structure:
```
backend/app/
â”œâ”€â”€ models.py              # All SQLModel definitions
â”œâ”€â”€ crud/                  # Database operations
â”œâ”€â”€ api/routes/           # API endpoints
â”œâ”€â”€ core/                 # Configuration & security
â””â”€â”€ alembic/versions/     # Database migrations
```

### Frontend Structure:
```
frontend/src/
â”œâ”€â”€ components/           # React components
â”œâ”€â”€ routes/              # TanStack Router routes
â”œâ”€â”€ client/              # Auto-generated API client
â”œâ”€â”€ hooks/               # Custom React hooks
â””â”€â”€ utils/               # Utility functions
```

## ğŸ¯ Naming Conventions

### Backend:
- **Models**: PascalCase (`User`, `Transaction`)
- **API Routes**: snake_case (`/api/v1/accounts/`)
- **CRUD Functions**: snake_case (`create_account`)
- **Database Tables**: snake_case (auto-generated)

### Frontend:
- **Components**: PascalCase (`AccountList`, `TransactionForm`)
- **Files**: PascalCase (`AccountList.tsx`)
- **Hooks**: camelCase (`useAccountData`)
- **API Calls**: camelCase (`readAccounts`)

## ğŸ” Authentication & Authorization

### Backend:
- Sá»­ dá»¥ng JWT tokens
- Dependency injection cho current user
- Role-based access control vá»›i `is_superuser`

### Frontend:
- Store JWT trong React Query cache
- Protected routes vá»›i authentication check
- Role-based UI rendering

## ğŸ§ª Testing Strategy

### Backend Testing:
- Unit tests cho CRUD operations: `source .venv/bin/activate && pytest`
- Integration tests cho API endpoints: `source .venv/bin/activate && pytest tests/integration/`
- Database fixtures cho test data

### Frontend Testing:
- Testing script: `npx tsc --noEmit`
- Component tests vá»›i React Testing Library: `npm test`
- E2E tests vá»›i Playwright: `npm run test:e2e`
- API mocking cho unit tests
- Linting: `npm run lint`

## ğŸ“Š State Management

### Frontend State:
- **Server State**: React Query (TanStack Query)
- **Client State**: React useState/useReducer
- **Form State**: React Hook Form
- **UI State**: Chakra UI components

## ğŸš€ Development Workflow

1. **Design Database Schema** â†’ Update `models.py`
2. **Create Migration** â†’ `source .venv/bin/activate && alembic revision --autogenerate`
3. **Implement CRUD** â†’ `crud/entity.py`
4. **Create API Routes** â†’ `api/routes/entity.py`
5. **Test Backend** â†’ `source .venv/bin/activate && pytest`
6. **Generate Client** â†’ `source .venv/bin/activate && ./scripts/generate-client.sh`
7. **Create Components** â†’ `components/Entity/`
8. **Add Routes** â†’ `routes/_layout/`
9. **Generate Routes** â†’ `cd frontend && npx @tanstack/router-cli generate`
10. **Test Frontend** â†’ `npm run lint && npx tsc --noEmit`

## ğŸ”§ Code Quality Rules

### Backend:
- Type hints cho táº¥t cáº£ functions
- Pydantic validation cho input/output
- SQLModel cho database operations
- Alembic cho migrations

### Frontend:
- TypeScript strict mode
- ESLint + Prettier formatting
- Component composition over inheritance
- Custom hooks cho business logic

## ğŸ”„ Code Refactoring Rules

### DRY Principle (Don't Repeat Yourself):
- **Utility Functions**: Táº¡o utility functions trong `backend/app/utils.py` cho logic chung
- **Validation Logic**: Sá»­ dá»¥ng shared validators thay vÃ¬ duplicate code
- **Component Logic**: Extract reusable logic vÃ o custom hooks

### File Organization for Utilities:
```
backend/app/
â”œâ”€â”€ utils.py              # Backend utility functions
â”œâ”€â”€ models.py             # Import from utils.py
â””â”€â”€ crud/                 # Import from utils.py

frontend/src/
â”œâ”€â”€ utils.ts              # Frontend utility functions
â”œâ”€â”€ components/           # Import from utils.ts
â””â”€â”€ hooks/                # Import from utils.ts
```

## ğŸ“ Documentation Standards

- **API Documentation**: Auto-generated tá»« FastAPI
- **Component Props**: TypeScript interfaces
- **Database Schema**: Alembic migration comments
- **README**: Update khi thÃªm tÃ­nh nÄƒng má»›i

## ğŸ¨ UI/UX Guidelines

- Sá»­ dá»¥ng Chakra UI components
- Responsive design vá»›i mobile-first
- Consistent spacing vÃ  typography
- Loading states vÃ  error handling
- Form validation vá»›i user feedback

## ğŸ” Debugging Tips

### Backend:
- Sá»­ dá»¥ng FastAPI automatic docs (`/docs`)
- Database query logging
- Pydantic validation errors

### Frontend:
- React DevTools
- TanStack Query DevTools
- Browser Network tab cho API calls
- Console logging cho state changes

## ğŸš¨ Error Handling & Debugging Rules

### âŒ KHÃ”NG BAO GIá»œ Fix Cháº¯p VÃ¡:
- **KhÃ´ng** thÃªm workaround hoáº·c band-aid solutions
- **KhÃ´ng** thÃªm setTimeout, useRef phá»©c táº¡p Ä‘á»ƒ "fix" symptoms
- **KhÃ´ng** ignore lá»—i hoáº·c suppress warnings

### âœ… LUÃ”N TÃ¬m NguyÃªn NhÃ¢n Gá»‘c Rá»…:
1. **PhÃ¢n tÃ­ch ká»¹ lÆ°á»¡ng** error message vÃ  stack trace
2. **TÃ¬m hiá»ƒu** táº¡i sao lá»—i xáº£y ra, khÃ´ng chá»‰ lÃ m sao Ä‘á»ƒ nÃ³ biáº¿n máº¥t
3. **Äá»c documentation** cá»§a library/framework liÃªn quan
4. **Kiá»ƒm tra** cÃ¡c component tÆ°Æ¡ng tá»± trong codebase

### ğŸ”§ Debugging Process:
```typescript
// âŒ BAD: Fix cháº¯p vÃ¡
const [isOpen, setIsOpen] = useState(false)
const resetRef = useRef<(() => void) | null>(null)
resetRef.current = reset // Side effect trong render!

useEffect(() => {
  if (!isOpen) {
    const timer = setTimeout(() => {
      resetRef.current?.()
    }, 150) // Magic number!
    return () => clearTimeout(timer)
  }
}, [isOpen])

// âœ… GOOD: TÃ¬m nguyÃªn nhÃ¢n vÃ  fix Ä‘Ãºng
const mutation = useMutation({
  onSuccess: () => {
    showSuccessToast("Success!")
    reset() // Reset trá»±c tiáº¿p trong callback
    setIsOpen(false) // ÄÃ³ng dialog
  }
})
```

### ğŸ¯ Debugging Checklist:
1. **Äá»c error message** cáº©n tháº­n
2. **TÃ¬m hiá»ƒu** nguyÃªn nhÃ¢n gá»‘c rá»…
3. **Kiá»ƒm tra** documentation vÃ  best practices
4. **Ãp dá»¥ng** giáº£i phÃ¡p Ä‘Æ¡n giáº£n nháº¥t
5. **Test** Ä‘á»ƒ Ä‘áº£m báº£o fix hoáº¡t Ä‘á»™ng
6. **Refactor** náº¿u cáº§n thiáº¿t

### ğŸ“‹ Common Error Patterns:

#### React Hooks Errors:
- **"Rendered more hooks than during the previous render"**: 
  - NguyÃªn nhÃ¢n: Conditional hooks hoáº·c side effects trong render
  - Fix: Äáº£m báº£o hooks Ä‘Æ°á»£c gá»i theo thá»© tá»± nháº¥t quÃ¡n

#### Form Validation Errors:
- **Form khÃ´ng reset sau submit**:
  - NguyÃªn nhÃ¢n: Timing issues vá»›i dialog state
  - Fix: Reset trong success callback, khÃ´ng dÃ¹ng useEffect phá»©c táº¡p

#### API Integration Errors:
- **CORS hoáº·c authentication issues**:
  - NguyÃªn nhÃ¢n: Configuration sai hoáº·c token expired
  - Fix: Kiá»ƒm tra API configuration vÃ  token management

---

**LÆ°u Ã½**: LuÃ´n tuÃ¢n theo pattern nÃ y Ä‘á»ƒ Ä‘áº£m báº£o consistency vÃ  maintainability cá»§a codebase.